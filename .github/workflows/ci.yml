name: CI

on: push

jobs:
  linux:
    name: Linux x64
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - run: cmake -B build
    - run: cmake --build build

    - name: Test
      run: ./build/rtsan_demo

  linux_cross_compile:
    name: Linux x64 -> ARM64 (Cross)
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install Linux ARM64 Toolchain
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu

    - name: Configure CMake
      run: |
        cmake -B build -DCMAKE_SYSTEM_PROCESSOR=aarch64 -DCMAKE_C_COMPILER_TARGET=aarch64-linux-gnu -DCMAKE_CXX_COMPILER_TARGET=aarch64-linux-gnu

    - name: Build
      run: cmake --build build

    - name: Test
      run: qemu-aarch64 ./build/rtsan_demo

  macos:
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-15-intel
            name: macOS 15 (x86_64)

          - os: macos-26
            name: macOS 26 (arm64)
    steps:
    - uses: actions/checkout@v4

    - run: cmake -B build
    - run: cmake --build build

    - name: Test
      run: ./build/rtsan_demo

  windows:
    name: Windows x64
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4

    - run: cmake -B build
    - run: cmake --build build

    - name: Test
      run: .\build\rtsan_demo
